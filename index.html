<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2EE Chat - ×”×¦×¤× ×” ××œ××”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .app-container { max-width: 800px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; min-height: 80vh; }
        .chat-box { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fafafa; border-radius: 5px; }
        .msg { padding: 8px 12px; margin-bottom: 10px; border-radius: 8px; max-width: 80%; display: block; word-wrap: break-word; }
        .msg-in { background-color: #d1e7dd; margin-right: auto; }
        .debug-text { font-size: 0.7em; color: #888; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="app-container">
        <h2 class="text-center mb-4">××¢×¨×›×ª ×¦'××˜ ××•×¦×¤× ×ª (E2EE)</h2>

        <div id="login-section">
            <div class="alert alert-primary">
                ×”××¢×¨×›×ª ××™×™×¦×¨×ª ××¤×ª×— ×¤×¨×˜×™ ×‘×“×¤×“×¤×Ÿ ×©×œ×š. ×”×©×¨×ª ×œ× ×™×›×•×œ ×œ×§×¨×•× ××ª ×”×”×•×“×¢×•×ª.
            </div>
            <input type="text" id="username" class="form-control mb-2" placeholder="×‘×—×¨ ×©× ××©×ª××© ×‘×× ×’×œ×™×ª (×œ××©×œ: dan)">
            <button onclick="registerUser()" class="btn btn-primary w-100">×¦×•×¨ ××¤×ª×—×•×ª ×•×›× ×¡</button>
            <p id="loading" class="text-center mt-2 text-muted" style="display:none;">××™×™×¦×¨ ××¤×ª×—×•×ª ×”×¦×¤× ×”...</p>
        </div>

        <div id="chat-section" style="display:none;">
            <div class="d-flex justify-content-between mb-2">
                <strong id="welcome-user"></strong>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">×”×ª× ×ª×§</button>
            </div>

            <div id="messages-area" class="chat-box"></div>

            <div class="input-group">
                <input type="text" id="recipient" class="form-control" placeholder="×œ××™ ×œ×©×œ×•×—?" style="max-width: 30%;">
                <input type="text" id="msg-content" class="form-control" placeholder="×ª×•×›×Ÿ ×”×”×•×“×¢×”...">
                <button onclick="sendMessage()" class="btn btn-success">×©×œ×— ğŸ”’</button>
            </div>
            <small class="text-muted mt-2">×”×¢×¨×”: ×”×•×“×¢×•×ª ×©×©×œ×—×ª ×œ× ×™×•×¦×’×• ×›××Ÿ (×›×™ ×”×Ÿ ××•×¦×¤× ×•×ª ×œ××§×‘×œ), ×¨×§ ×”×•×“×¢×•×ª ×©× ×©×œ×—×• ××œ×™×š.</small>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ×”×’×“×¨×•×ª ×”×—×™×‘×•×¨ - ××¢×•×“×›×Ÿ ×œ×¤×™ ×”×ª××•× ×” ×©×©×œ×—×ª!
    // ==========================================
    const PROJECT_ID = '694abef500045ee01528';       
    const DATABASE_ID = '694abf9300062560c636';     
    
    // ××–×”×™× ×œ×¤×™ ×”×ª××•× ×” ×©×œ×š:
    const USERS_COL_ID = 'users'; 
    const MSGS_COL_ID = 'msgs'; 

    // ××ª×—×•×œ
    const { Client, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject(PROJECT_ID);
    const databases = new Databases(client);

    // ××©×ª× ×™× ×œ××¤×ª×—×•×ª
    let myUser = localStorage.getItem('chat_user');
    let myPrivKey = localStorage.getItem('chat_priv');

    // ×›× ×™×¡×” ××•×˜×•××˜×™×ª ×× ×”××¤×ª×—×•×ª ×§×™×™××™×
    if(myUser && myPrivKey) {
        showChat(myUser);
    }

    // --- 1. ×”×¨×©××” ×•×™×¦×™×¨×ª ××¤×ª×—×•×ª ---
    async function registerUser() {
        const username = document.getElementById('username').value.trim();
        if(!username) return alert("×—×•×‘×” ×œ×”×›× ×™×¡ ×©×");

        document.getElementById('loading').style.display = 'block';

        try {
            // ×‘×“×™×§×” ×× ×”××©×ª××© ×›×‘×¨ ×§×™×™× ×‘×©×¨×ª
            // ×”×¢×¨×”: ×× ×–×” ×”××©×ª××© ×”×¨××©×•×Ÿ ××™ ×¤×¢×, ×™×™×ª×›×Ÿ ×©×ª×”×™×” ×©×’×™××ª ×”×¨×©××” ×× ×œ× ×”×’×“×¨×ª Permissions ×œ-Any
            // × × ×¡×” ×¤×©×•×˜ ×œ×™×¦×•×¨, ×•×× × ×›×©×œ ×‘×’×œ×œ ID ×›×¤×•×œ × ×“×¢ ×©×”×•× ×§×™×™×
        } catch(e) {}

        // ×™×¦×™×¨×ª ××¤×ª×—×•×ª RSA
        const crypt = new JSEncrypt({ default_key_size: 2048 });
        
        setTimeout(async () => {
            const privateKey = crypt.getPrivateKey();
            const publicKey = crypt.getPublicKey();

            try {
                // ×‘×“×™×§×” ×™×“× ×™×ª ×× ×”××©×ª××© ×ª×¤×•×¡ ×œ×¤× ×™ ×™×¦×™×¨×”
                const check = await databases.listDocuments(DATABASE_ID, USERS_COL_ID, [Query.equal('username', username)]);
                if(check.total > 0) {
                     alert("×©× ×”××©×ª××© ×ª×¤×•×¡! × ×¡×” ×©× ××—×¨.");
                     document.getElementById('loading').style.display = 'none';
                     return;
                }

                // ×©××™×¨×ª ×”××¤×ª×— ×”×¦×™×‘×•×¨×™ ×‘×©×¨×ª
                await databases.createDocument(DATABASE_ID, USERS_COL_ID, ID.unique(), {
                    username: username,
                    public_key: publicKey
                });

                // ×©××™×¨×” ××§×•××™×ª
                localStorage.setItem('chat_user', username);
                localStorage.setItem('chat_priv', privateKey);
                
                showChat(username);
            } catch (err) {
                console.error(err);
                alert("×©×’×™××”: " + err.message + "\n(×•×“× ×©×™×¦×¨×ª ××ª ×”×©×“×•×ª ×‘×˜×‘×œ×” ×•×”×’×“×¨×ª ×”×¨×©××•×ª Permissions ×œ-Any)");
            }
            document.getElementById('loading').style.display = 'none';
        }, 200);
    }

    function showChat(name) {
        myUser = name;
        myPrivKey = localStorage.getItem('chat_priv');
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('chat-section').style.display = 'block';
        document.getElementById('welcome-user').innerText = "××—×•×‘×¨: " + name;
        loadMessages();
        setInterval(loadMessages, 3000); // ×¨×¢× ×•×Ÿ ×›×œ 3 ×©× ×™×•×ª
    }

    // --- 2. ×©×œ×™×—×” ---
    async function sendMessage() {
        const recipient = document.getElementById('recipient').value.trim();
        const text = document.getElementById('msg-content').value;
        if(!recipient || !text) return alert("×—×¡×¨ × ××¢×Ÿ ××• ×ª×•×›×Ÿ");

        try {
            // ××¦×™××ª ×”××¤×ª×— ×”×¦×™×‘×•×¨×™ ×©×œ ×”× ××¢×Ÿ
            const res = await databases.listDocuments(DATABASE_ID, USERS_COL_ID, [Query.equal('username', recipient)]);
            if(res.total === 0) return alert("×”××©×ª××© " + recipient + " ×œ× × ××¦×");
            
            const receiverPublicKey = res.documents[0].public_key;

            // ×”×¦×¤× ×”
            const encryptor = new JSEncrypt();
            encryptor.setPublicKey(receiverPublicKey);
            const encryptedData = encryptor.encrypt(text);

            if(!encryptedData) return alert("×©×’×™××ª ×”×¦×¤× ×” (××•×œ×™ ×˜×§×¡×˜ ××¨×•×š ××“×™?)");

            // ×©×œ×™×—×” ×œ×©×¨×ª
            await databases.createDocument(DATABASE_ID, MSGS_COL_ID, ID.unique(), {
                sender_name: myUser,
                recipient_id: recipient,
                content: encryptedData,
                timestamp: new Date().toISOString()
            });

            document.getElementById('msg-content').value = '';
            alert("× ×©×œ×— ×‘×”×¦×œ×—×” (××•×¦×¤×Ÿ)");

        } catch(err) {
            console.error(err);
            alert("×©×’×™××” ×‘×©×œ×™×—×”: " + err.message);
        }
    }

    // --- 3. ×§×‘×œ×” ×•×¤×¢× ×•×— ---
    async function loadMessages() {
        if(!myUser) return;

        try {
            // ×©×œ×™×¤×ª ×”×•×“×¢×•×ª ×©××™×•×¢×“×•×ª ×œ×™
            const res = await databases.listDocuments(DATABASE_ID, MSGS_COL_ID, [
                Query.equal('recipient_id', myUser),
                Query.orderDesc('timestamp'),
                Query.limit(20)
            ]);

            const area = document.getElementById('messages-area');
            area.innerHTML = '';

            const decryptor = new JSEncrypt();
            decryptor.setPrivateKey(myPrivKey);

            res.documents.forEach(msg => {
                let originalText = decryptor.decrypt(msg.content);
                if(!originalText) originalText = "â›” ×©×’×™××” ×‘×¤×¢× ×•×— (××¤×ª×— ×¤×¨×˜×™ ×œ× ×ª×•××)";

                area.innerHTML += `
                    <div class="msg msg-in">
                        <strong>×××ª ${msg.sender_name}:</strong><br>
                        ${originalText}
                        <span class="debug-text">×”×•×¦×¤×Ÿ ×›: ${msg.content.substring(0, 10)}...</span>
                    </div>
                `;
            });

        } catch(err) {
            console.error("Error loading", err);
        }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
</script>

</body>
</html>
