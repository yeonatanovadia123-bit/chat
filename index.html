<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .msg { background: #d1e7dd; padding: 10px; margin: 5px 0; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center">צ'אט מאובטח</h2>
    
    <div id="login-screen">
        <input type="text" id="username" class="form-control mb-2" placeholder="שם משתמש (באנגלית)">
        <button onclick="register()" class="btn btn-primary w-100">כנס</button>
        <p id="status" class="text-muted mt-2"></p>
    </div>

    <div id="chat-screen" style="display:none;">
        <h3>שלום <span id="my-name"></span></h3>
        <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ddd; margin-bottom: 10px; padding: 10px;"></div>
        <input type="text" id="to-user" class="form-control mb-1" placeholder="למי לשלוח?">
        <input type="text" id="msg-text" class="form-control mb-1" placeholder="הודעה...">
        <button onclick="send()" class="btn btn-success w-100">שלח</button>
    </div>
</div>

<script>
    // הגדרות החיבור שלך
    const client = new Appwrite.Client()
        .setEndpoint('https://cloud.appwrite.io/v1')
        .setProject('694abef500045ee01528'); // הפרויקט שלך

    const db = new Appwrite.Databases(client);
    
    const DB_ID = '694abf9300062560c636'; // הדאטה בייס שלך
    const USERS = 'users'; 
    const MSGS = 'msgs';

    let me = localStorage.getItem('u');
    let key = localStorage.getItem('k');

    if(me && key) showChat(me);

    async function register() {
        const name = document.getElementById('username').value;
        document.getElementById('status').innerText = "יוצר מפתחות...";
        
        // יצירת מפתח
        const crypt = new JSEncrypt({default_key_size: 2048});
        setTimeout(async () => {
            const pub = crypt.getPublicKey();
            const priv = crypt.getPrivateKey();

            try {
                // שמירה בשרת
                await db.createDocument(DB_ID, USERS, Appwrite.ID.unique(), {
                    username: name,
                    public_key: pub
                });
                
                localStorage.setItem('u', name);
                localStorage.setItem('k', priv);
                showChat(name);
            } catch(e) {
                alert("שגיאה או ששם המשתמש תפוס");
            }
        }, 500);
    }

    function showChat(name) {
        me = name;
        key = localStorage.getItem('k');
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('my-name').innerText = name;
        setInterval(loadMsgs, 3000);
    }

    async function send() {
        const to = document.getElementById('to-user').value;
        const txt = document.getElementById('msg-text').value;

        // 1. מביאים את המפתח של החבר
        const u = await db.listDocuments(DB_ID, USERS, [Appwrite.Query.equal('username', to)]);
        if(u.total === 0) return alert("משתמש לא נמצא");

        // 2. מצפינים
        const encryptor = new JSEncrypt();
        encryptor.setPublicKey(u.documents[0].public_key);
        const encrypted = encryptor.encrypt(txt);

        // 3. שולחים
        await db.createDocument(DB_ID, MSGS, Appwrite.ID.unique(), {
            sender_name: me,
            recipient_id: to,
            content: encrypted,
            timestamp: new Date().toISOString()
        });
        alert("נשלח!");
    }

    async function loadMsgs() {
        const res = await db.listDocuments(DB_ID, MSGS, [
            Appwrite.Query.equal('recipient_id', me),
            Appwrite.Query.orderDesc('timestamp')
        ]);

        const box = document.getElementById('messages');
        box.innerHTML = '';
        const decryptor = new JSEncrypt();
        decryptor.setPrivateKey(key);

        res.documents.forEach(m => {
            let txt = decryptor.decrypt(m.content);
            if(!txt) txt = "הודעה לא קריאה";
            box.innerHTML += `<div class='msg'><b>${m.sender_name}:</b> ${txt}</div>`;
        });
    }
</script>
</body>
</html>
