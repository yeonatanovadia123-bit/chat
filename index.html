<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“§ ×¦'××˜ + ×ª×™×‘×ª ××™×™×œ ×××•×‘×˜×—×ª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh; direction: rtl; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(255,107,107,0.3); }
        .tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; }
        .tab { padding: 15px 30px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .tab-content { display: none; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        
        /* ×¦'××˜ */
        .chat-container { display: flex; gap: 20px; height: 600px; }
        .chat-sidebar { width: 300px; background: #f8f9fa; border-radius: 15px; padding: 20px; overflow-y: auto; }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; margin-bottom: 20px; background: #fafbfc; }
        .message { margin: 15px 0; padding: 15px; border-radius: 18px; max-width: 70%; position: relative; }
        .message.sent { background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-left: auto; }
        .message.received { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; }
        .quote { background: rgba(255,255,255,0.2); padding: 8px 12px; border-left: 4px solid rgba(255,255,255,0.5); margin: 5px 0; border-radius: 8px; font-size: 14px; }
        
        /* ×ª×™×‘×ª ××™×™×œ */
        .email-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .email-list { height: 500px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 15px; padding: 15px; background: white; }
        .email-item { padding: 20px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.2s; border-radius: 10px; margin-bottom: 10px; }
        .email-item:hover { background: #f0f8ff; transform: translateX(-5px); }
        .email-item.selected { background: #e3f2fd; border: 2px solid #667eea; }
        .email-content { padding: 25px; background: #f8f9fa; border-radius: 15px; height: 500px; overflow-y: auto; }
        
        /* ×§×œ×˜ */
        input, textarea { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 16px; margin: 10px 0; transition: border-color 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 25px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; margin: 5px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .contacts { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .contact-item:hover { background: #f0f8ff; }
        .room-id { background: #e8f5e8; padding: 12px; border-radius: 10px; font-family: monospace; font-size: 14px; word-break: break-all; margin: 10px 0; }
        
        @media (max-width: 768px) { .chat-container, .email-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ğŸ“§ ×¦'××˜ + ×ª×™×‘×ª ××™×™×œ P2P</h1>
            <div style="font-size: 18px; opacity: 0.9;">×¢×•×’×™×•×ª â€¢ ×¦×™×˜×•×˜ â€¢ LocalStorage â€¢ ×œ×œ× ×©×¨×ª</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('chat')">ğŸ’¬ ×¦'××˜</button>
            <button class="tab" onclick="switchTab('email')">ğŸ“§ ×ª×™×‘×ª ××™×™×œ</button>
        </div>

        <!-- ×˜××‘ ×¦'××˜ -->
        <div id="chat-tab" class="tab-content active">
            <div class="contacts">
                <h3>ğŸ‘¥ ×× ×©×™ ×§×©×¨ ×©××•×¨×™× (×¢×•×’×™×•×ª)</h3>
                <input id="contact-name" placeholder="×©× (×“×•×“)">
                <input id="room-id-input" placeholder="Room ID (××• ×™×¦×•×¨ ××•×˜×•××˜×™)">
                <button onclick="saveContact()">ğŸ’¾ ×©××•×¨ ××™×© ×§×©×¨</button>
                <div id="contacts-list"></div>
            </div>
            
            <div class="room-id">
                <strong>Room ID × ×•×›×—×™:</strong> <span id="current-room">chat-room-1</span>
                <button onclick="copyRoomID()">ğŸ“‹ ×”×¢×ª×§</button>
            </div>

            <div class="chat-container">
                <div class="chat-sidebar">
                    <h4>ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×—×“×¨×™×</h4>
                    <div id="rooms-list"></div>
                </div>
                <div class="chat-main">
                    <div id="chat-messages"></div>
                    <div style="display: flex; gap: 15px;">
                        <input id="chat-message" placeholder="×›×ª×•×‘ ×”×•×“×¢×”... (×œ×—×¥ > ×œ×”×“×’×©×” ×œ×¦×™×˜×•×˜)" onkeypress="if(event.key==='Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" id="chat-send-btn">×©×œ×— ğŸš€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ×˜××‘ ×ª×™×‘×ª ××™×™×œ -->
        <div id="email-tab" class="tab-content">
            <div class="email-layout">
                <div>
                    <h3>ğŸ“¥ Incoming</h3>
                    <div id="inbox-list" class="email-list"></div>
                </div>
                <div>
                    <h3>ğŸ“¤ Outbox</h3>
                    <div id="sent-list" class="email-list"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin-top: 20px;">
                <div>
                    <h3>âœï¸ ××™×™×œ ×—×“×©</h3>
                    <input id="email-to-room" placeholder="Room ID ×”× ××¢×Ÿ">
                    <input id="email-subject" placeholder="× ×•×©×">
                    <textarea id="email-body" placeholder="×ª×•×›×Ÿ ×”××™×™×œ..." rows="5"></textarea>
                    <button onclick="sendEmail()">ğŸ“¤ ×©×œ×— ××™×™×œ</button>
                </div>
                <div id="email-preview" class="email-content" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentRoom = getCookie('lastRoom') || 'chat-room-1';
        document.getElementById('current-room').textContent = currentRoom;
        document.getElementById('room-id-input').value = currentRoom;

        window.onload = () => {
            loadContacts();
            loadRooms();
            loadEmails();
            updateChat();
            setInterval(updateChat, 1000);
        };

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
            if (tab === 'email') loadEmails();
        }

        // ×¢×•×’×™×•×ª
        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }
        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, '');
        }

        // ×× ×©×™ ×§×©×¨ (×¢×•×’×™×•×ª)
        function saveContact() {
            const name = document.getElementById('contact-name').value.trim();
            const roomId = document.getElementById('room-id-input').value.trim() || crypto.randomUUID().slice(0,8);
            if (!name || !roomId) return alert('××œ× ×©× ×•-Room ID');
            
            setCookie(`contact_${roomId}`, JSON.stringify({name, roomId, timestamp: Date.now()}));
            currentRoom = roomId;
            document.getElementById('current-room').textContent = roomId;
            document.getElementById('chat-message').placeholder = `×”×•×“×¢×” ×œ-${name}...`;
            loadContacts();
            setCookie('lastRoom', roomId);
            showStatus(`âœ… ${name} × ×©××¨ ×‘××™×© ×§×©×¨!`, 'success');
        }

        function loadContacts() {
            const contacts = [];
            document.cookie.split('; ').forEach(cookie => {
                if (cookie.startsWith('contact_')) {
                    try {
                        const roomId = cookie.split('=')[0].replace('contact_', '');
                        const data = JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                        contacts.push(data);
                    } catch(e) {}
                }
            });
            document.getElementById('contacts-list').innerHTML = contacts.map(c => 
                `<div class="contact-item" onclick="selectContact('${c.roomId}', '${c.name}')">
                    ğŸ‘¤ ${c.name} 
                    <small>${c.roomId.slice(0,8)}...</small>
                </div>`
            ).join('');
        }

        function selectContact(roomId, name) {
            currentRoom = roomId;
            document.getElementById('current-room').textContent = roomId;
            document.getElementById('chat-message').placeholder = `×”×•×“×¢×” ×œ-${name}...`;
            setCookie('lastRoom', roomId);
            updateChat();
        }

        function copyRoomID() {
            navigator.clipboard.writeText(currentRoom);
            showStatus('âœ… Room ID ×”×•×¢×ª×§!', 'success');
        }

        // ×¦'××˜
        function updateChat() {
            const messages = JSON.parse(localStorage.getItem(currentRoom) || '[]');
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(msg => {
                let quoteHtml = '';
                if (msg.quote) {
                    quoteHtml = `<div class="quote">${msg.quote}</div>`;
                }
                return `<div class="message ${msg.sender === '××ª×”' ? 'sent' : 'received'}">
                    ${quoteHtml}
                    <strong>${msg.sender}:</strong> ${escapeHtml(msg.text)}<br>
                    <small>${msg.time}</small>
                </div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-message');
            const text = input.value.trim();
            if (!text) return;
            
            const quoteMatch = text.match(/^>\s*(.*)/);
            const quote = quoteMatch ? quoteMatch[1] : null;
            const cleanText = quote ? text.replace(/^>\s*/, '') : text;
            
            const messages = JSON.parse(localStorage.getItem(currentRoom) || '[]');
            messages.push({
                text: cleanText,
                sender: '××ª×”',
                time: new Date().toLocaleTimeString('he-IL'),
                quote
            });
            localStorage.setItem(currentRoom, JSON.stringify(messages.slice(-100)));
            
            input.value = '';
            updateChat();
        }

        // ×—×“×¨×™×
        function loadRooms() {
            const rooms = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('chat-room-')) {
                    rooms.push(key);
                }
            }
            document.getElementById('rooms-list').innerHTML = rooms.map(room => 
                `<div class="contact-item" onclick="currentRoom='${room}';document.getElementById('current-room').textContent='${room}';updateChat();">
                    ğŸ“± ${room.slice(0,12)}...
                </div>`
            ).join('');
        }

        // ×ª×™×‘×ª ××™×™×œ
        function sendEmail() {
            const roomId = document.getElementById('email-to-room').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            const body = document.getElementById('email-body').value.trim();
            
            if (!roomId || !body) return alert('××œ× Room ID ×•×ª×•×›×Ÿ');
            
            const email = {
                id: crypto.randomUUID(),
                to: roomId,
                from: currentRoom,
                subject,
                body,
                timestamp: Date.now()
            };
            
            // ×©××•×¨ Sent
            let sent = JSON.parse(localStorage.getItem('sent-emails') || '[]');
            sent.unshift(email);
            localStorage.setItem('sent-emails', JSON.stringify(sent.slice(0,100)));
            
            // ×©××•×¨ Incoming (×¡×™××•×œ×¦×™×”)
            let inbox = JSON.parse(localStorage.getItem('inbox-emails') || '[]');
            inbox.unshift(email);
            localStorage.setItem('inbox-emails', JSON.stringify(inbox.slice(0,100)));
            
            loadEmails();
            showStatus('âœ… ××™×™×œ × ×©×œ×—!', 'success');
            document.getElementById('email-body').value = '';
        }

        function loadEmails() {
            const inbox = JSON.parse(localStorage.getItem('inbox-emails') || '[]');
            const sent = JSON.parse(localStorage.getItem('sent-emails') || '[]');
            
            document.getElementById('inbox-list').innerHTML = inbox.map(email => 
                `<div class="email-item" onclick="openEmail('${email.id}', true)">
                    ğŸ“¥ ${email.from.slice(0,12)}... - ${email.subject}
                </div>`
            ).join('');
            
            document.getElementById('sent-list').innerHTML = sent.map(email => 
                `<div class="email-item" onclick="openEmail('${email.id}', false)">
                    ğŸ“¤ ${email.to.slice(0,12)}... - ${email.subject}
                </div>`
            ).join('');
        }

        function openEmail(id, isInbox) {
            const emails = JSON.parse(localStorage.getItem(isInbox ? 'inbox-emails' : 'sent-emails') || '[]');
            const email = emails.find(e => e.id === id);
            if (email) {
                document.getElementById('email-preview').innerHTML = `
                    <h4>${email.subject}</h4>
                    <p><strong>×:</strong> ${email.from.slice(0,20)}...</p>
                    <p><strong>××œ:</strong> ${email.to.slice(0,20)}...</p>
                    <div style="margin-top: 20px; white-space: pre-wrap;">${escapeHtml(email.body)}</div>
                `;
                document.getElementById('email-preview').style.display = 'block';
            }
        }

        function showStatus(msg, type) {
            const status = document.createElement('div');
            status.textContent = msg;
            status.className = `status ${type}`;
            status.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 15px 25px; border-radius: 25px; color: white; font-weight: bold;';
            document.body.appendChild(status);
            setTimeout(() => status.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
