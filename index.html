<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Mailbox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    
    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', sans-serif; }
        .main-card { max-width: 900px; margin: 30px auto; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 80vh; display: flex; flex-direction: column; }
        .sidebar { background: #f8f9fa; border-left: 1px solid #dee2e6; padding: 20px; width: 250px; }
        .content-area { flex: 1; padding: 20px; }
        .mail-row { cursor: pointer; transition: 0.2s; }
        .mail-row:hover { background-color: #f1f3f5; }
        .unread { font-weight: bold; background-color: #e8f0fe; }
        .secure-badge { font-size: 0.8em; background: #d1e7dd; color: #0f5132; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div id="login-screen" class="container mt-5" style="max-width: 400px;">
        <div class="card p-4">
            <h3 class="text-center mb-4">×›× ×™×¡×” ×œ××™×™×œ ×”×××•×‘×˜×—</h3>
            <div class="alert alert-info small">×”××¢×¨×›×ª ×ª×©×ª××© ×‘××¤×ª×— ×”×¦×¤× ×” ×¤×¨×˜×™ ×©× ×©××¨ ×‘×“×¤×“×¤×Ÿ ×©×œ×š ×‘×œ×‘×“.</div>
            <input type="text" id="username" class="form-control mb-3" placeholder="×©× ××©×ª××© (×‘×× ×’×œ×™×ª)">
            <button onclick="login()" class="btn btn-primary w-100">×¦×•×¨ ×–×”×•×ª / ×›× ×¡</button>
            <div id="login-status" class="text-center mt-2 text-muted"></div>
        </div>
    </div>

    <div id="mail-app" class="main-card" style="display:none;">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h4 class="m-0">SecureMail <span class="secure-badge">E2EE</span></h4>
            <div>
                <span id="current-user" class="me-3 fw-bold"></span>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">×”×ª× ×ª×§</button>
            </div>
        </div>

        <div class="d-flex flex-grow-1">
            <div class="sidebar d-none d-md-block">
                <button onclick="showCompose()" class="btn btn-primary w-100 mb-4">âœï¸ ××™×™×œ ×—×“×©</button>
                <div class="list-group">
                    <a href="#" onclick="loadInbox()" class="list-group-item list-group-item-action active">ğŸ“¥ ×“×•××¨ × ×›× ×¡</a>
                    <a href="#" class="list-group-item list-group-item-action disabled">ğŸ“¤ ×“×•××¨ ×™×•×¦× (×‘×§×¨×•×‘)</a>
                </div>
            </div>

            <div class="content-area">
                
                <div id="inbox-view">
                    <h5 class="mb-3">×“×•××¨ × ×›× ×¡</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 20%">×©×•×œ×—</th>
                                    <th style="width: 50%">× ×•×©×</th>
                                    <th style="width: 30%">×ª××¨×™×š</th>
                                </tr>
                            </thead>
                            <tbody id="email-list">
                                </tbody>
                        </table>
                    </div>
                    <p id="empty-msg" class="text-center text-muted mt-5" style="display:none;">××™×Ÿ ××™×™×œ×™× ×—×“×©×™×</p>
                </div>

                <div id="read-view" style="display:none;">
                    <button onclick="loadInbox()" class="btn btn-sm btn-secondary mb-3">ğŸ”™ ×—×–×•×¨ ×œ×¨×©×™××”</button>
                    <div class="card">
                        <div class="card-header bg-white">
                            <h4 id="read-subject"></h4>
                            <div class="text-muted small">
                                ×××ª: <strong id="read-sender"></strong> | <span id="read-date"></span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p id="read-content" style="white-space: pre-wrap;"></p>
                            <hr>
                            <small class="text-muted">ğŸ”’ ×ª×•×›×Ÿ ×–×” ×”×•×¦×¤×Ÿ ××§×¦×” ×œ×§×¦×” ×•×¤×•×¢× ×— ×›×¢×ª ×‘×“×¤×“×¤×Ÿ ×©×œ×š.</small>
                        </div>
                    </div>
                </div>

                <div id="compose-view" style="display:none;">
                    <h5 class="mb-3">×›×ª×™×‘×ª ×”×•×“×¢×” ×××•×‘×˜×—×ª</h5>
                    <form onsubmit="event.preventDefault(); sendEmail();">
                        <div class="mb-3">
                            <label>××œ (×©× ××©×ª××©):</label>
                            <input type="text" id="compose-to" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>× ×•×©×:</label>
                            <input type="text" id="compose-subject" class="form-control" required>
                            <small class="text-muted">* ×”× ×•×©× × ×©×œ×— ×›×˜×§×¡×˜ ×’×œ×•×™ ×›×“×™ ×œ×”×¦×™×’ ×‘×¨×©×™××”</small>
                        </div>
                        <div class="mb-3">
                            <label>×ª×•×›×Ÿ ×”×”×•×“×¢×” (×™×•×¦×¤×Ÿ):</label>
                            <textarea id="compose-body" class="form-control" rows="10" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">×©×œ×— ××•×¦×¤×Ÿ ğŸ”’</button>
                        <button type="button" onclick="loadInbox()" class="btn btn-link text-secondary">×‘×™×˜×•×œ</button>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ×”×’×“×¨×•×ª - ××œ ×ª×™×’×¢ ×× ×–×” ×›×‘×¨ × ×›×•×Ÿ
    // ==========================================
    const PROJECT_ID = '694abef500045ee01528';       
    const DATABASE_ID = '694abf9300062560c636';     
    const USERS_COL = 'users'; 
    const MSGS_COL = 'msgs'; 

    // ××ª×—×•×œ Appwrite
    const { Client, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject(PROJECT_ID);
    const databases = new Databases(client);

    // × ×™×”×•×œ ××©×ª××©
    let myUsername = localStorage.getItem('mail_user');
    let myPrivKey = localStorage.getItem('mail_priv');

    // ×‘×“×™×§×ª ×”×ª×—×‘×¨×•×ª ××•×˜×•××˜×™×ª
    if (myUsername && myPrivKey) {
        openMailbox(myUsername);
    }

    // --- ×œ×•×’×™×Ÿ / ×”×¨×©××” ---
    async function login() {
        const username = document.getElementById('username').value.trim();
        if (!username) return alert("×× × ×”×›× ×¡ ×©× ××©×ª××©");
        
        document.getElementById('login-status').innerText = "××™×™×¦×¨ ××¤×ª×—×•×ª ×”×¦×¤× ×”...";

        // 1. × ×¡×” ×œ×™×¦×•×¨ ××©×ª××© ×—×“×©
        const crypt = new JSEncrypt({ default_key_size: 2048 });
        
        setTimeout(async () => {
            const privateKey = crypt.getPrivateKey();
            const publicKey = crypt.getPublicKey();

            try {
                // ×‘×“×™×§×” ×× ×§×™×™×
                const check = await databases.listDocuments(DATABASE_ID, USERS_COL, [Query.equal('username', username)]);
                
                if (check.total === 0) {
                    // ×™×•×¦×¨ ××©×ª××© ×—×“×©
                    await databases.createDocument(DATABASE_ID, USERS_COL, ID.unique(), {
                        username: username,
                        public_key: publicKey
                    });
                    // ×©×•××¨ ××¤×ª×— ×¤×¨×˜×™ ×—×“×©
                    localStorage.setItem('mail_user', username);
                    localStorage.setItem('mail_priv', privateKey);
                    openMailbox(username);
                } else {
                    // ××©×ª××© ×§×™×™× - ×× ×¡×” ×œ×”×ª×—×‘×¨
                    // ×”×¢×¨×”: ×‘××¢×¨×›×ª ×××™×ª×™×ª ×¦×¨×™×š ×¡×™×¡××”. ×›××Ÿ ×× ×—× ×• ×‘×•×“×§×™× ×× ×™×© ××¤×ª×— ×©××•×¨ ×‘××—×©×‘
                    if (localStorage.getItem('mail_user') === username) {
                        openMailbox(username);
                    } else {
                        alert("×©× ×”××©×ª××© ×ª×¤×•×¡, ×•×”××¤×ª×— ×”×¤×¨×˜×™ ×œ× × ××¦× ×‘××—×©×‘ ×”×–×”.");
                    }
                }
            } catch (err) {
                console.error(err);
                alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + err.message);
            }
            document.getElementById('login-status').innerText = "";
        }, 100);
    }

    function openMailbox(user) {
        myUsername = user;
        myPrivKey = localStorage.getItem('mail_priv');
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('mail-app').style.display = 'flex';
        document.getElementById('current-user').innerText = user;
        loadInbox();
    }

    // --- × ×™×•×•×˜ ---
    function showView(viewId) {
        ['inbox-view', 'read-view', 'compose-view'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
    }

    function showCompose() {
        showView('compose-view');
        document.getElementById('compose-to').value = '';
        document.getElementById('compose-subject').value = '';
        document.getElementById('compose-body').value = '';
    }

    // --- ×˜×¢×™× ×ª ×“×•××¨ × ×›× ×¡ ---
    async function loadInbox() {
        showView('inbox-view');
        const list = document.getElementById('email-list');
        list.innerHTML = '<tr><td colspan="3" class="text-center">×˜×•×¢×Ÿ...</td></tr>';

        try {
            const response = await databases.listDocuments(DATABASE_ID, MSGS_COL, [
                Query.equal('recipient_id', myUsername),
                Query.orderDesc('timestamp'),
                Query.limit(50)
            ]);

            list.innerHTML = '';
            if (response.total === 0) {
                document.getElementById('empty-msg').style.display = 'block';
                return;
            }
            document.getElementById('empty-msg').style.display = 'none';

            response.documents.forEach(email => {
                const date = new Date(email.timestamp).toLocaleDateString('he-IL') + ' ' + new Date(email.timestamp).toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'});
                
                // ×”×•×¡×¤×ª ×©×•×¨×” ×œ×˜×‘×œ×”
                const row = `
                    <tr class="mail-row" onclick="readEmail('${email.$id}', '${email.sender_name}', '${email.subject}', '${date}')">
                        <td class="fw-bold">${email.sender_name}</td>
                        <td>${email.subject || '(×œ×œ× × ×•×©×)'}</td>
                        <td class="text-muted small">${date}</td>
                    </tr>
                `;
                list.innerHTML += row;
            });
            
            // ×©×•××¨×™× ××ª ×”×”×•×“×¢×•×ª ×‘×–×™×›×¨×•×Ÿ ×–×× ×™ ×›×“×™ ×©× ×•×›×œ ×œ×¤×ª×•×— ××•×ª×Ÿ
            window.currentEmails = response.documents;

        } catch (error) {
            console.error(error);
            list.innerHTML = '<tr><td colspan="3" class="text-danger text-center">×©×’×™××” ×‘×˜×¢×™× ×ª ×“×•××¨ (×‘×“×•×§ Console)</td></tr>';
        }
    }

    // --- ×§×¨×™××ª ××™×™×œ (×¤×¢× ×•×—) ---
    function readEmail(id, sender, subject, date) {
        // ××•×¦× ××ª ×”××™×™×œ ××”×–×™×›×¨×•×Ÿ
        const email = window.currentEmails.find(e => e.$id === id);
        if (!email) return;

        showView('read-view');
        document.getElementById('read-subject').innerText = subject;
        document.getElementById('read-sender').innerText = sender;
        document.getElementById('read-date').innerText = date;
        document.getElementById('read-content').innerText = "××¤×¢× ×— ×”×¦×¤× ×”...";

        // ×¤×¢× ×•×—
        setTimeout(() => {
            const decryptor = new JSEncrypt();
            decryptor.setPrivateKey(myPrivKey);
            const decrypted = decryptor.decrypt(email.content);
            
            if (decrypted) {
                document.getElementById('read-content').innerText = decrypted;
            } else {
                document.getElementById('read-content').innerHTML = "<span class='text-danger'>â›” ×›×©×œ ×‘×¤×¢× ×•×— ×”×”×•×“×¢×”. ×™×™×ª×›×Ÿ ×©×”××¤×ª×— ×”×¤×¨×˜×™ ×©×œ×š ××™× ×• ×ª×•××.</span>";
            }
        }, 100);
    }

    // --- ×©×œ×™×—×ª ××™×™×œ ---
    async function sendEmail() {
        const toUser = document.getElementById('compose-to').value.trim();
        const subject = document.getElementById('compose-subject').value;
        const body = document.getElementById('compose-body').value;

        if(!toUser || !body) return alert("×—×¡×¨×™× ×¤×¨×˜×™×");

        // 1. ××¦×™××ª ×”××¤×ª×— ×”×¦×™×‘×•×¨×™ ×©×œ ×”× ××¢×Ÿ
        try {
            const userSearch = await databases.listDocuments(DATABASE_ID, USERS_COL, [Query.equal('username', toUser)]);
            
            if (userSearch.total === 0) {
                return alert("×”××©×ª××© " + toUser + " ×œ× × ××¦× ×‘××¢×¨×›×ª");
            }

            const receiverKey = userSearch.documents[0].public_key;

            // 2. ×”×¦×¤× ×”
            const encryptor = new JSEncrypt();
            encryptor.setPublicKey(receiverKey);
            const encryptedBody = encryptor.encrypt(body);

            if (!encryptedBody) return alert("×”×”×•×“×¢×” ××¨×•×›×” ××“×™ ×œ×”×¦×¤× ×” ×–×• (× ×¡×” ×œ×§×¦×¨)");

            // 3. ×©×œ×™×—×”
            await databases.createDocument(DATABASE_ID, MSGS_COL, ID.unique(), {
                sender_name: myUsername,
                recipient_id: toUser,
                subject: subject,
                content: encryptedBody,
                timestamp: new Date().toISOString()
            });

            alert("×”××™×™×œ × ×©×œ×— ×‘×”×¦×œ×—×”!");
            loadInbox();

        } catch (error) {
            console.error(error);
            alert("×©×’×™××” ×‘×©×œ×™×—×”: " + error.message);
        }
    }

    function logout() {
        localStorage.removeItem('mail_user');
        localStorage.removeItem('mail_priv');
        location.reload();
    }
</script>

</body>
</html>
