<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ ×¦'××˜ + ××™×™×œ ××œ× - ×¢×•×‘×“!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; background: #f8f9fa; }
        .tab.active { background: #667eea; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .section { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        input, textarea, select { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; margin: 10px 0; font-size: 16px; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 25px; border-radius: 12px; cursor: pointer; font-size: 16px; margin: 5px; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #chat-messages, .email-list { height: 400px; overflow-y: auto; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; background: #f8f9fa; margin-bottom: 20px; }
        .message, .email-item { padding: 15px; border-radius: 15px; margin: 10px 0; cursor: pointer; }
        .message.sent { background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-left: auto; }
        .message.received { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; }
        .quote { background: rgba(255,255,255,0.2); padding: 10px; border-left: 4px solid white; margin: 10px 0; border-radius: 8px; font-style: italic; }
        .contacts-list { max-height: 200px; overflow-y: auto; }
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .contact-item:hover { background: #f0f8ff; }
        .status { padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”’ ×¦'××˜ + ×ª×™×‘×ª ××™×™×œ ××œ××”</h1>
            <div>×¢×•×’×™×•×ª â€¢ ×¦×™×˜×•×˜ â€¢ BroadcastChannel â€¢ ×¢×•×‘×“ ×‘×™×Ÿ ×—×œ×•× ×•×ª!</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('chat')">ğŸ’¬ ×¦'××˜</button>
            <button class="tab" onclick="switchTab('email')">ğŸ“§ ××™×™×œ</button>
            <button class="tab" onclick="switchTab('contacts')">ğŸ‘¥ ×× ×©×™ ×§×©×¨</button>
        </div>

        <!-- ×¦'××˜ -->
        <div id="chat-tab" class="tab-content active">
            <div class="section">
                <h3>ğŸ“± ×—×“×¨ ×¦'××˜</h3>
                <input id="roomId" value="room-123" placeholder="Room ID (×©×™×ª×•×£ ×¢× ×—×‘×¨)">
                <button onclick="joinChatRoom()">×”×¦×˜×¨×£ ×œ×—×“×¨</button>
                <div id="chat-status" class="status" style="display:none;"></div>
            </div>
            <div id="chat-container" style="display:none;">
                <div id="chat-messages"></div>
                <div style="display:flex; gap:15px;">
                    <input id="chat-message" placeholder="> ×œ×¦×™×˜×•×˜ | Enter ×œ×©×œ×™×—×”" onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" disabled>×©×œ×—</button>
                </div>
            </div>
        </div>

        <!-- ×ª×™×‘×ª ××™×™×œ -->
        <div id="email-tab" class="tab-content">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="section">
                    <h3>ğŸ“¥ Incoming</h3>
                    <div id="inbox-list" class="email-list"></div>
                </div>
                <div class="section">
                    <h3>ğŸ“¤ × ×©×œ×—</h3>
                    <div id="sent-list" class="email-list"></div>
                </div>
            </div>
            <div class="section">
                <input id="email-room" placeholder="Room ID ×”× ××¢×Ÿ">
                <input id="email-subject" placeholder="× ×•×©×">
                <textarea id="email-body" placeholder="×ª×•×›×Ÿ..." rows="4"></textarea>
                <button onclick="sendEmail()">ğŸ“¤ ×©×œ×— ××™×™×œ</button>
            </div>
        </div>

        <!-- ×× ×©×™ ×§×©×¨ -->
        <div id="contacts-tab" class="tab-content">
            <div class="section">
                <h3>ğŸ’¾ ×©××•×¨ ××™×© ×§×©×¨ (×¢×•×’×™×•×ª)</h3>
                <input id="contact-name" placeholder="×©× (×“×•×“)">
                <input id="contact-room" placeholder="Room ID">
                <button onclick="saveContact()">×©××•×¨</button>
                <div id="contacts-list" class="contacts-list"></div>
            </div>
        </div>
    </div>

    <script>
        let currentChannel = null;
        let chatConnected = false;

        // ×˜××‘×™×
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ×¢×•×’×™×•×ª
        function setCookie(name, value, days=365) {
            const date = new Date(Date.now() + days*864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))}; expires=${date}; path=/`;
        }
        function getCookie(name) {
            return document.cookie.split(';').reduce((r,v) => {
                const [k, val] = v.split('=');
                return k.trim() === name ? JSON.parse(decodeURIComponent(val.trim())) : r;
            }, null);
        }

        // ×× ×©×™ ×§×©×¨
        function saveContact() {
            const name = document.getElementById('contact-name').value.trim();
            const room = document.getElementById('contact-room').value.trim();
            if (!name || !room) return showStatus('âŒ ××œ× ×©× ×•-Room ID', 'error');
            
            const contacts = getCookie('contacts') || [];
            contacts.unshift({name, room, time: Date.now()});
            setCookie('contacts', contacts.slice(0,50));
            
            loadContacts();
            showStatus(`âœ… ${name} × ×©××¨!`, 'success');
        }

        function loadContacts() {
            const contacts = getCookie('contacts') || [];
            document.getElementById('contacts-list').innerHTML = contacts.map(c => 
                `<div class="contact-item" onclick="selectContact('${c.name}', '${c.room}')">
                    ğŸ‘¤ ${c.name} 
                    <small>${c.room.slice(0,10)}...</small>
                </div>`
            ).join('');
        }

        function selectContact(name, room) {
            document.getElementById('roomId').value = room;
            document.getElementById('chat-message').placeholder = `×œ-${name}...`;
            showStatus(`× ×‘×—×¨: ${name}`, 'success');
        }

        // ×¦'××˜
        function joinChatRoom() {
            const roomId = document.getElementById('roomId').value.trim() || 'room-123';
            
            if (currentChannel) currentChannel.close();
            
            currentChannel = new BroadcastChannel(roomId);
            chatConnected = true;
            
            document.getElementById('chat-container').style.display = 'block';
            document.querySelector('#chat-container button').disabled = false;
            document.getElementById('chat-status').innerHTML = `âœ… ××—×•×‘×¨ ×œ-${roomId}`;
            document.getElementById('chat-status').className = 'status success';
            document.getElementById('chat-status').style.display = 'block';
            
            // ×§×‘×œ ×”×•×“×¢×•×ª
            currentChannel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                addChatMessage(data.sender, data.text, data.quote, data.time);
            };
            
            // ×˜×¢×Ÿ ×”×™×¡×˜×•×¨×™×”
            const history = JSON.parse(localStorage.getItem(`chat_${roomId}`) || '[]');
            history.forEach(msg => addChatMessage(msg.sender, msg.text, msg.quote, msg.time));
        }

        function sendChatMessage() {
            const text = document.getElementById('chat-message').value.trim();
            if (!text || !chatConnected) return;
            
            const quoteMatch = text.match(/^>\s*(.+)/);
            const quote = quoteMatch ? quoteMatch[1] : null;
            const cleanText = quote ? text.replace(/^>\s*/, '') : text;
            
            const message = {
                sender: '××ª×”',
                text: cleanText,
                quote,
                time: new Date().toLocaleTimeString('he-IL')
            };
            
            currentChannel.postMessage(JSON.stringify(message));
            document.getElementById('chat-message').value = '';
            
            // ×©××•×¨ ×”×™×¡×˜×•×¨×™×”
            const history = JSON.parse(localStorage.getItem(`chat_${document.getElementById('roomId').value}`) || '[]');
            history.push(message);
            localStorage.setItem(`chat_${document.getElementById('roomId').value}`, JSON.stringify(history.slice(-100)));
        }

        function addChatMessage(sender, text, quote, time) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${sender === '××ª×”' ? 'sent' : 'received'}`;
            
            let html = `<strong>${sender}:</strong> ${escapeHtml(text)}<br><small>${time}</small>`;
            if (quote) html = `<div class="quote">${escapeHtml(quote)}</div>` + html;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ××™×™×œ
        function sendEmail() {
            const roomId = document.getElementById('email-room').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            const body = document.getElementById('email-body').value.trim();
            
            if (!roomId || !body) return showStatus('âŒ ××œ× Room ID ×•×ª×•×›×Ÿ', 'error');
            
            const email = {
                id: Date.now(),
                from: document.getElementById('roomId').value || 'room-123',
                to: roomId,
                subject,
                body,
                time: new Date().toLocaleTimeString('he-IL')
            };
            
            let inbox = JSON.parse(localStorage.getItem('inbox') || '[]');
            let sent = JSON.parse(localStorage.getItem('sent') || '[]');
            
            inbox.unshift(email);
            sent.unshift(email);
            
            localStorage.setItem('inbox', JSON.stringify(inbox.slice(0,100)));
            localStorage.setItem('sent', JSON.stringify(sent.slice(0,100)));
            
            loadEmails();
            showStatus('âœ… ××™×™×œ × ×©×œ×—!', 'success');
        }

        function loadEmails() {
            const inbox = JSON.parse(localStorage.getItem('inbox') || '[]');
            const sent = JSON.parse(localStorage.getItem('sent') || '[]');
            
            document.getElementById('inbox-list').innerHTML = inbox.map(e => 
                `<div class="email-item" onclick="showEmail('${e.id}')">
                    ğŸ“¥ ${e.from.slice(0,12)}... - ${e.subject}
                </div>`
            ).join('');
            
            document.getElementById('sent-list').innerHTML = sent.map(e => 
                `<div class="email-item" onclick="showEmail('${e.id}')">
                    ğŸ“¤ ${e.to.slice(0,12)}... - ${e.subject}
                </div>`
            ).join('');
        }

        function showEmail(id) {
            const emails = JSON.parse(localStorage.getItem('inbox') || '[]');
            const email = emails.find(e => e.id == id);
            alert(`${email.subject}\n\n${email.body}`);
        }

        function showStatus(msg, type) {
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = msg;
            document.querySelector('.container').prepend(status);
            setTimeout(() => status.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ××ª×—×•×œ
        window.onload = () => {
            loadContacts();
            loadEmails();
        };
    </script>
</body>
</html>
